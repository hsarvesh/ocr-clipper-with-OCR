<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <title>Manage Credits - OCR System</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="src/css/styles.css">
    <link rel="stylesheet" href="src/css/credits-styles.css">

    <script src="src/js/auth.js"></script>
    <script src="src/js/credits.js"></script>
</head>

<body>
    <header class="header">
        <div class="header-left">
            <h1 class="page-title">Manage Credits</h1>
        </div>
        <div class="header-right">
            <div class="user-profile">
                <button id="user-name" class="profile-button" onclick="toggleProfileMenu(event)">
                    <img id="user-photo" class="user-photo" src="" alt="Profile photo">
                    <span id="user-display-name"></span>
                    <span class="material-icons">arrow_drop_down</span>
                </button>
                <div id="profile-menu" class="profile-menu">
                    <div class="profile-header">
                        <div class="profile-name" id="profile-full-name"></div>
                        <div class="profile-email" id="profile-email"></div>
                    </div>
                    <div class="credits-section">
                        <div class="credits-info">
                            <span class="credits-icon">ðŸ’Ž</span>
                            <span class="credits-amount-lg" id="menu-credits-amount">-</span>
                            <span class="credits-label">Credits Available</span>
                        </div>
                        <div class="credits-actions">
                            <a href="test-credits.html" class="menu-item-button">
                                <span class="material-icons">add_circle</span>
                                Add Credits
                            </a>
                            <a href="test-credits.html" class="menu-item-button">
                                <span class="material-icons">manage_accounts</span>
                                Manage Credits
                            </a>
                        </div>
                    </div>
                    <div class="profile-divider"></div>
                    <div class="profile-info">
                        <div class="menu-item button-like" onclick="window.location.href='processing-history.html'">
                            <span class="material-icons">history</span>
                            <span>Processing History</span>
                        </div>
                        <div class="menu-item">
                            <span class="material-icons">access_time</span>
                            <span id="last-login"></span>
                        </div>
                    </div>
                    <div class="profile-divider"></div>
                    <div class="menu-item sign-out" onclick="signOut()">
                        <span class="material-icons">logout</span>
                        Sign Out
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="main-container">
        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="success-message" class="success-message" style="display: none;"></div>

        <div class="credits-display">
            <div class="credits-amount" id="credits-display">-</div>
            <div class="credits-label">Available Credits</div>
        </div>

        <div class="credits-actions">
            <button class="button" onclick="window.location.href='purchase.html'">Purchase Credits</button>
            <button class="button secondary" onclick="window.location.href='test-credits.html'">Get Test
                Credits</button>
        </div>

        <div class="navigation">
            <button class="button secondary" onclick="window.location.href='index.html'">Back to Home</button>
            <button class="button secondary" onclick="window.location.href='processing-history.html'">View
                History</button>
        </div>
    </main>

    <script>
        let creditsManager = null;

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        // Initialize the page
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            // Initialize credits manager
            creditsManager = new CreditsManager(user.uid);

            try {
                const credits = await creditsManager.getCredits();
                document.getElementById('credits-display').textContent = credits;
                document.getElementById('menu-credits-amount').textContent = credits;
            } catch (error) {
                console.error('Error fetching credits:', error);
                showError('Error loading credits. Please try again.');
            }
        });
    </script>
</body>

</html>